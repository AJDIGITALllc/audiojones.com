<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Pricing Integration Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #1a1a1a; color: #fff; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #333; border-radius: 5px; }
        .success { background: #1a4d1a; }
        .error { background: #4d1a1a; }
        .info { background: #1a1a4d; }
        button { padding: 10px 20px; margin: 5px; background: #007acc; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #005a9e; }
        pre { background: #2a2a2a; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .log { margin: 10px 0; padding: 10px; background: #2a2a2a; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Enhanced Pricing Integration Test</h1>
        
        <div class="test-section info">
            <h2>Test Status</h2>
            <div id="status">Ready to test...</div>
        </div>

        <div class="test-section">
            <h2>Step 1: Create Test SKU</h2>
            <button onclick="createTestSku()">Create Test SKU in Firestore</button>
            <div id="sku-result" class="log"></div>
        </div>

        <div class="test-section">
            <h2>Step 2: Test Webhook Integration</h2>
            <button onclick="testWebhook()" id="webhook-btn" disabled>Test Webhook with Firestore SKU</button>
            <div id="webhook-result" class="log"></div>
        </div>

        <div class="test-section">
            <h2>Step 3: Verify Customer Data</h2>
            <button onclick="verifyCustomer()" id="verify-btn" disabled>Verify Customer Creation</button>
            <div id="verify-result" class="log"></div>
        </div>

        <div class="test-section">
            <h2>Step 4: Test Fallback</h2>
            <button onclick="testFallback()">Test Hardcoded Fallback</button>
            <div id="fallback-result" class="log"></div>
        </div>
    </div>

    <script>
        const adminKey = 'gGho3TE8ztiSAMvORfyCDem62Fk0xpW1';
        let testSku = '';
        let testEmail = '';

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.innerHTML += `<div class="${type}">[${timestamp}] ${message}</div>`;
        }

        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.className = type;
            status.textContent = message;
        }

        async function createTestSku() {
            try {
                updateStatus('Creating test SKU...', 'info');
                
                testSku = `test-enhanced-sku-${Date.now()}`;
                testEmail = `test-enhanced-${Date.now()}@example.com`;
                
                const skuData = {
                    billing_sku: testSku,
                    service_id: 'ai-automation',
                    tier_id: 'enterprise',
                    active: true
                };

                const response = await fetch('/api/admin/pricing', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'admin-key': adminKey
                    },
                    body: JSON.stringify(skuData)
                });

                if (response.ok) {
                    const result = await response.json();
                    log('sku-result', `‚úÖ SKU created successfully: ${testSku}`, 'success');
                    log('sku-result', `üìä Response: ${JSON.stringify(result, null, 2)}`, 'info');
                    
                    document.getElementById('webhook-btn').disabled = false;
                    updateStatus('Test SKU created, ready for webhook test', 'success');
                } else {
                    const error = await response.text();
                    log('sku-result', `‚ùå Failed to create SKU: ${error}`, 'error');
                    updateStatus('Failed to create test SKU', 'error');
                }
            } catch (error) {
                log('sku-result', `‚ùå Error: ${error.message}`, 'error');
                updateStatus('Error creating test SKU', 'error');
            }
        }

        async function testWebhook() {
            try {
                updateStatus('Testing webhook integration...', 'info');
                
                const webhookPayload = {
                    event_type: 'subscription.created',
                    user: {
                        email: testEmail
                    },
                    billing_sku: testSku,
                    timestamp: Math.floor(Date.now() / 1000)
                };

                // For testing, we'll use a simple POST without HMAC signature
                const response = await fetch('/api/whop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-whop-timestamp': Math.floor(Date.now() / 1000).toString()
                    },
                    body: JSON.stringify(webhookPayload)
                });

                if (response.ok) {
                    log('webhook-result', `‚úÖ Webhook processed successfully`, 'success');
                    log('webhook-result', `üìä Status: ${response.status}`, 'info');
                    
                    document.getElementById('verify-btn').disabled = false;
                    updateStatus('Webhook processed, ready to verify customer', 'success');
                    
                    // Wait a moment then verify
                    setTimeout(() => verifyCustomer(), 2000);
                } else {
                    const error = await response.text();
                    log('webhook-result', `‚ùå Webhook failed: ${error}`, 'error');
                    updateStatus('Webhook processing failed', 'error');
                }
            } catch (error) {
                log('webhook-result', `‚ùå Error: ${error.message}`, 'error');
                updateStatus('Error testing webhook', 'error');
            }
        }

        async function verifyCustomer() {
            try {
                updateStatus('Verifying customer data...', 'info');
                
                const response = await fetch(`/api/admin/customers/${encodeURIComponent(testEmail)}`, {
                    headers: {
                        'admin-key': adminKey
                    }
                });

                if (response.ok) {
                    const customer = await response.json();
                    log('verify-result', `‚úÖ Customer found: ${customer.email}`, 'success');
                    log('verify-result', `üìä Service: ${customer.service_name}`, 'info');
                    log('verify-result', `üìä Tier: ${customer.tier}`, 'info');
                    log('verify-result', `üìä Full data: ${JSON.stringify(customer, null, 2)}`, 'info');
                    
                    if (customer.tier === 'enterprise' && customer.service_name === 'ai-automation') {
                        log('verify-result', `üéØ SUCCESS: Firestore SKU was used correctly!`, 'success');
                        updateStatus('‚úÖ Enhanced pricing integration working perfectly!', 'success');
                    } else {
                        log('verify-result', `‚ö†Ô∏è Unexpected data - might be using fallback`, 'error');
                        updateStatus('‚ö†Ô∏è Integration might not be working as expected', 'error');
                    }
                } else {
                    const error = await response.text();
                    log('verify-result', `‚ùå Failed to find customer: ${error}`, 'error');
                    updateStatus('Customer verification failed', 'error');
                }
            } catch (error) {
                log('verify-result', `‚ùå Error: ${error.message}`, 'error');
                updateStatus('Error verifying customer', 'error');
            }
        }

        async function testFallback() {
            try {
                updateStatus('Testing hardcoded fallback...', 'info');
                
                const fallbackEmail = `test-fallback-${Date.now()}@example.com`;
                
                const webhookPayload = {
                    event_type: 'subscription.created',
                    user: {
                        email: fallbackEmail
                    },
                    billing_sku: 'personal-brand-t1-monthly', // This should exist in hardcoded data
                    timestamp: Math.floor(Date.now() / 1000)
                };

                const response = await fetch('/api/whop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-whop-timestamp': Math.floor(Date.now() / 1000).toString()
                    },
                    body: JSON.stringify(webhookPayload)
                });

                if (response.ok) {
                    log('fallback-result', `‚úÖ Fallback webhook processed`, 'success');
                    
                    // Wait and verify
                    setTimeout(async () => {
                        const customerResponse = await fetch(`/api/admin/customers/${encodeURIComponent(fallbackEmail)}`, {
                            headers: { 'admin-key': adminKey }
                        });
                        
                        if (customerResponse.ok) {
                            const customer = await customerResponse.json();
                            log('fallback-result', `‚úÖ Fallback customer created: ${customer.email}`, 'success');
                            log('fallback-result', `üìä Used hardcoded SKU: personal-brand-t1-monthly`, 'info');
                            log('fallback-result', `üìä Service: ${customer.service_name}, Tier: ${customer.tier}`, 'info');
                        }
                    }, 2000);
                } else {
                    const error = await response.text();
                    log('fallback-result', `‚ùå Fallback test failed: ${error}`, 'error');
                }
            } catch (error) {
                log('fallback-result', `‚ùå Error: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>