version: "1"
env:
  REPO_DIR: "C:\\Users\\tyron.AUDIOJONES\\OneDrive\\Documents\\AJDIGITAL\\DEV\\audiojones.com"
  REPO_URL: "https://github.com/AJDIGITALllc/audiojones.com.git"
  GIT_BRANCH: "main"
  COMMIT_MSG: "Update hero section with ImageKit assets and parallax"
  VERCEL_PROJECT: "audiojones-com"

tasks:
  deploy:
    shell: powershell
    steps:
      - run: cd "$env:REPO_DIR"
      - run: |
          if (-not (Test-Path .git)) { git init; git branch -M $env:GIT_BRANCH }
          $hasOrigin = (git remote 2>$null) -contains 'origin'
          if (-not $hasOrigin -and $env:REPO_URL) { git remote add origin $env:REPO_URL }
      - run: git status -sb
      - run: git add -A
      - run: |
          if ((git status --porcelain).Length -gt 0) {
            git commit -m "$env:COMMIT_MSG"
          } else {
            Write-Host "No changes to commit."
          }
      - run: git push origin $env:GIT_BRANCH
      - run: git log -1 --pretty="Pushed %H %h at %cs: %s"
      - run: |
          if (-not (Test-Path package.json)) {
            Write-Error "Missing package.json. Restore it before Vercel deploy."
            exit 1
          }
      - run: |
          if ($env:VERCEL_TOKEN) {
            vercel link --confirm --project $env:VERCEL_PROJECT --token $env:VERCEL_TOKEN
          } else {
            vercel link --confirm --project $env:VERCEL_PROJECT
          }
      - run: |
          if ($env:VERCEL_TOKEN) {
            $out = vercel --prod --confirm --token $env:VERCEL_TOKEN 2>&1
          } else {
            $out = vercel --prod --confirm 2>&1
          }
          $match = ($out | Select-String -Pattern 'https://[^\s]+\.vercel\.app' -AllMatches).Matches
          if ($match.Count -gt 0) {
            $url = $match[-1].Value
            Write-Host "Deployed $url"
          } else {
            Write-Host $out
            Write-Error "Could not parse deploy URL from Vercel output."
            exit 1
          }

