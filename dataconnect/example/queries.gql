# Example queries for a simple movie app.

# @auth() directives control who can call each operation.
# Anyone should be able to list all movies, so the auth level is set to PUBLIC
query ListMovies @auth(level: PUBLIC, insecureReason: "Anyone can list all movies.") {
  movies {
    id
    title
    imageUrl
    genre
  }
}

# List all users, only admins should be able to list all users, so we use NO_ACCESS
query ListUsers @auth(level: NO_ACCESS) {
  users {
    id
    username
  }
}

# Logged in users can list all their reviews and movie titles associated with the review
# Since the query uses the uid of the current authenticated user, we set auth level to USER
query ListUserReviews @auth(level: USER) {
  user(key: { id_expr: "auth.uid" }) {
    id
    username
    # <field>_on_<foreign_key_field> makes it easy to grab info from another table
    # Here, we use it to grab all the reviews written by the user.
    reviews: reviews_on_user {
      rating
      reviewDate
      reviewText
      movie {
        id
        title
      }
    }
  }
}

# Get movie by id
query GetMovieById($id: UUID!) @auth(level: PUBLIC, insecureReason: "Anyone can get a movie by id.") {
  movie(id: $id) {
    id
    title
    imageUrl
    genre
    metadata: movieMetadata_on_movie {
      rating
      releaseYear
      description
    }
    reviews: reviews_on_movie {
      reviewText
      reviewDate
      rating
      user {
        id
        username
      }
    }
  }
}

# Search for movies, actors, and reviews
query SearchMovie($titleInput: String, $genre: String) @auth(level: PUBLIC, insecureReason: "Anyone can search for movies.") {
  movies(
    where: {
      _and: [{ genre: { eq: $genre } }, { title: { contains: $titleInput } }]
    }
  ) {
    id
    title
    genre
    imageUrl
  }
}

# Blog Automation System Queries

# Public blog queries - anyone can read published blogs
query ListPublishedBlogs($pillar: String, $limit: Int = 10, $offset: Int = 0) 
  @auth(level: PUBLIC, insecureReason: "Anyone can read published blog posts.") {
  blogDrafts(
    where: { status: { eq: "published" }, pillar: { eq: $pillar } }
    orderBy: { publishedAt: DESC }
    limit: $limit
    offset: $offset
  ) {
    id
    title
    slug
    pillar
    seoDescription
    ogImage
    readingTime
    publishedAt
    keyTakeaways
    ctaType
    ctaHeadline
    ctaDescription
    ctaLink
    # Get performance metrics
    contentPerformance: contentPerformance_on_draft {
      views
      engagementTime
      socialShares
      performanceScore
    }
  }
}

# Get published blog by slug
query GetPublishedBlogBySlug($slug: String!) 
  @auth(level: PUBLIC, insecureReason: "Anyone can read a published blog post.") {
  blogDrafts(where: { slug: { eq: $slug }, status: { eq: "published" } }) {
    id
    title
    slug
    pillar
    content
    seoTitle
    seoDescription
    seoKeywords
    ogImage
    faqs
    keyTakeaways
    structuredData
    ctaType
    ctaHeadline
    ctaDescription
    ctaLink
    frameworkUsed
    readingTime
    publishedAt
    # Get performance metrics
    contentPerformance: contentPerformance_on_draft {
      views
      engagementTime
      conversions
      socialShares
      searchImpressions
      bounceRate
      performanceScore
    }
    # Get A/B test variants
    variants: blogVariants_on_draft(where: { active: { eq: true } }) {
      id
      variantType
      variantValue
      testPercentage
    }
  }
}

# Admin queries - require admin authentication
query ListAllDrafts($status: String, $pillar: String, $source: String, $limit: Int = 50, $offset: Int = 0) 
  @auth(level: NO_ACCESS, insecureReason: "Admin only - handled by API middleware") {
  blogDrafts(
    where: { 
      status: { eq: $status }, 
      pillar: { eq: $pillar },
      source: { eq: $source }
    }
    orderBy: { updatedAt: DESC }
    limit: $limit
    offset: $offset
  ) {
    id
    title
    slug
    pillar
    source
    status
    seoDescription
    readingTime
    createdAt
    updatedAt
    scheduledFor
    publishedAt
    # Get scheduling info
    schedule: contentSchedule_on_draft {
      scheduledFor
      status
      distributionChannels
      retryCount
      errorMessage
    }
    # Get performance if published
    contentPerformance: contentPerformance_on_draft {
      views
      performanceScore
    }
  }
}

# Get draft by ID for editing
query GetDraftById($id: UUID!) 
  @auth(level: NO_ACCESS, insecureReason: "Admin only - handled by API middleware") {
  blogDraft(id: $id) {
    id
    pillar
    source
    status
    title
    slug
    content
    seoTitle
    seoDescription
    seoKeywords
    ogImage
    faqs
    keyTakeaways
    structuredData
    ctaType
    ctaHeadline
    ctaDescription
    ctaLink
    researchPayload
    frameworkUsed
    readingTime
    createdAt
    updatedAt
    scheduledFor
    publishedAt
    # Get variants for A/B testing
    variants: blogVariants_on_draft {
      id
      variantType
      originalValue
      variantValue
      testPercentage
      active
    }
    # Get performance data
    contentPerformance: contentPerformance_on_draft {
      views
      engagementTime
      conversions
      socialShares
      searchImpressions
      bounceRate
      performanceScore
      lastUpdated
    }
    # Get scheduling info
    schedule: contentSchedule_on_draft {
      id
      scheduledFor
      status
      distributionChannels
      retryCount
      lastAttempt
      errorMessage
    }
  }
}

# Get content performance dashboard data
query GetContentPerformanceDashboard($pillar: String, $days: Int = 30) 
  @auth(level: NO_ACCESS, insecureReason: "Admin only - handled by API middleware") {
  contentPerformances(
    where: { 
      pillar: { eq: $pillar },
      lastUpdated: { gte_expr: "TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL @days DAY)" }
    }
    orderBy: { performanceScore: DESC }
  ) {
    id
    slug
    pillar
    views
    engagementTime
    conversions
    socialShares
    searchImpressions
    bounceRate
    performanceScore
    lastUpdated
    draft {
      title
      publishedAt
      ctaType
    }
  }
}

# Get topical map for content planning
query GetTopicalMap($pillar: String, $active: Boolean = true) 
  @auth(level: NO_ACCESS, insecureReason: "Admin only - handled by API middleware") {
  topicalMaps(
    where: { pillar: { eq: $pillar }, active: { eq: $active } }
    orderBy: { priority: ASC, lastGenerated: ASC }
  ) {
    id
    pillar
    topic
    persona
    intent
    sourceUrls
    priority
    lastGenerated
    active
    createdAt
  }
}

# Get scheduled content for calendar view
query GetScheduledContent($startDate: Timestamp!, $endDate: Timestamp!) 
  @auth(level: NO_ACCESS, insecureReason: "Admin only - handled by API middleware") {
  contentSchedules(
    where: { 
      scheduledFor: { gte: $startDate, lte: $endDate }
    }
    orderBy: { scheduledFor: ASC }
  ) {
    id
    scheduledFor
    status
    distributionChannels
    retryCount
    errorMessage
    draft {
      id
      title
      pillar
      slug
      status
      readingTime
    }
  }
}
