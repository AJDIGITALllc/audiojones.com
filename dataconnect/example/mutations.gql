# Example mutations for a simple movie app

# Create a movie based on user input
mutation CreateMovie($title: String!, $genre: String!, $imageUrl: String!)
@auth(level: USER_EMAIL_VERIFIED, insecureReason: "Any email verified users can create a new movie.") {
  movie_insert(data: { title: $title, genre: $genre, imageUrl: $imageUrl })
}

# Upsert (update or insert) a user's username based on their auth.uid
mutation UpsertUser($username: String!) @auth(level: USER) {
  # The "auth.uid" server value ensures that users can only register their own user.
  user_upsert(data: { id_expr: "auth.uid", username: $username })
}

# Add a review for a movie
mutation AddReview($movieId: UUID!, $rating: Int!, $reviewText: String!)
@auth(level: USER) {
  review_upsert(
    data: {
      userId_expr: "auth.uid"
      movieId: $movieId
      rating: $rating
      reviewText: $reviewText
      # reviewDate defaults to today in the schema. No need to set it manually.
    }
  )
}

# Logged in user can delete their review for a movie
mutation DeleteReview($movieId: UUID!) @auth(level: USER) {
  # The "auth.uid" server value ensures that users can only delete their own reviews.
  review_delete(key: { userId_expr: "auth.uid", movieId: $movieId })
}

# Blog Automation System Mutations

# Create a new blog draft (admin only - handled by API middleware)
mutation CreateBlogDraft(
  $pillar: String!,
  $source: String!,
  $title: String!,
  $slug: String!,
  $content: String!,
  $seoTitle: String,
  $seoDescription: String,
  $seoKeywords: [String!],
  $ogImage: String,
  $faqs: String,
  $keyTakeaways: [String!],
  $structuredData: String,
  $ctaType: String!,
  $ctaHeadline: String!,
  $ctaDescription: String!,
  $ctaLink: String!,
  $researchPayload: String,
  $frameworkUsed: String,
  $readingTime: Int
) @auth(level: NO_ACCESS, insecureReason: "Admin only - handled by API middleware") {
  blogDraft_insert(data: {
    pillar: $pillar,
    source: $source,
    status: "draft",
    title: $title,
    slug: $slug,
    content: $content,
    seoTitle: $seoTitle,
    seoDescription: $seoDescription,
    seoKeywords: $seoKeywords,
    ogImage: $ogImage,
    faqs: $faqs,
    keyTakeaways: $keyTakeaways,
    structuredData: $structuredData,
    ctaType: $ctaType,
    ctaHeadline: $ctaHeadline,
    ctaDescription: $ctaDescription,
    ctaLink: $ctaLink,
    researchPayload: $researchPayload,
    frameworkUsed: $frameworkUsed,
    readingTime: $readingTime
  })
}

# Update blog draft
mutation UpdateBlogDraft(
  $id: UUID!,
  $title: String,
  $slug: String,
  $content: String,
  $status: String,
  $seoTitle: String,
  $seoDescription: String,
  $seoKeywords: [String!],
  $ogImage: String,
  $faqs: String,
  $keyTakeaways: [String!],
  $structuredData: String,
  $ctaType: String,
  $ctaHeadline: String,
  $ctaDescription: String,
  $ctaLink: String,
  $readingTime: Int,
  $scheduledFor: Timestamp,
  $publishedAt: Timestamp
) @auth(level: NO_ACCESS, insecureReason: "Admin only - handled by API middleware") {
  blogDraft_update(
    id: $id,
    data: {
      title: $title,
      slug: $slug,
      content: $content,
      status: $status,
      seoTitle: $seoTitle,
      seoDescription: $seoDescription,
      seoKeywords: $seoKeywords,
      ogImage: $ogImage,
      faqs: $faqs,
      keyTakeaways: $keyTakeaways,
      structuredData: $structuredData,
      ctaType: $ctaType,
      ctaHeadline: $ctaHeadline,
      ctaDescription: $ctaDescription,
      ctaLink: $ctaLink,
      readingTime: $readingTime,
      scheduledFor: $scheduledFor,
      publishedAt: $publishedAt,
      updatedAt_expr: "request.time"
    }
  )
}

# Delete blog draft
mutation DeleteBlogDraft($id: UUID!) @auth(level: NO_ACCESS, insecureReason: "Admin only - handled by API middleware") {
  blogDraft_delete(id: $id)
}

# Create or update topical map entry
mutation UpsertTopicalMap(
  $id: UUID,
  $pillar: String!,
  $topic: String!,
  $persona: String!,
  $intent: String!,
  $sourceUrls: [String!],
  $priority: Int,
  $active: Boolean
) @auth(level: NO_ACCESS, insecureReason: "Admin only - handled by API middleware") {
  topicalMap_upsert(data: {
    id: $id,
    pillar: $pillar,
    topic: $topic,
    persona: $persona,
    intent: $intent,
    sourceUrls: $sourceUrls,
    priority: $priority,
    active: $active,
    lastGenerated_expr: "request.time",
    updatedAt_expr: "request.time"
  })
}

# Create blog variant for A/B testing
mutation CreateBlogVariant(
  $draftId: UUID!,
  $variantType: String!,
  $originalValue: String!,
  $variantValue: String!,
  $testPercentage: Int
) @auth(level: NO_ACCESS, insecureReason: "Admin only - handled by API middleware") {
  blogVariant_insert(data: {
    draftId: $draftId,
    variantType: $variantType,
    originalValue: $originalValue,
    variantValue: $variantValue,
    testPercentage: $testPercentage,
    active: true
  })
}

# Update blog variant
mutation UpdateBlogVariant(
  $id: UUID!,
  $variantValue: String,
  $testPercentage: Int,
  $performanceData: String,
  $active: Boolean
) @auth(level: NO_ACCESS, insecureReason: "Admin only - handled by API middleware") {
  blogVariant_update(
    id: $id,
    data: {
      variantValue: $variantValue,
      testPercentage: $testPercentage,
      performanceData: $performanceData,
      active: $active,
      updatedAt_expr: "request.time"
    }
  )
}

# Create or update content performance
mutation UpsertContentPerformance(
  $draftId: UUID!,
  $slug: String!,
  $pillar: String!,
  $views: Int,
  $engagementTime: Int,
  $conversions: Int,
  $socialShares: Int,
  $searchImpressions: Int,
  $bounceRate: Float,
  $performanceScore: Float
) @auth(level: NO_ACCESS, insecureReason: "Admin only - handled by API middleware") {
  contentPerformance_upsert(data: {
    draftId: $draftId,
    slug: $slug,
    pillar: $pillar,
    views: $views,
    engagementTime: $engagementTime,
    conversions: $conversions,
    socialShares: $socialShares,
    searchImpressions: $searchImpressions,
    bounceRate: $bounceRate,
    performanceScore: $performanceScore,
    lastUpdated_expr: "request.time"
  })
}

# Create content schedule
mutation CreateContentSchedule(
  $draftId: UUID!,
  $scheduledFor: Timestamp!,
  $distributionChannels: [String!]
) @auth(level: NO_ACCESS, insecureReason: "Admin only - handled by API middleware") {
  contentSchedule_insert(data: {
    draftId: $draftId,
    scheduledFor: $scheduledFor,
    status: "pending",
    distributionChannels: $distributionChannels,
    retryCount: 0
  })
}

# Update content schedule
mutation UpdateContentSchedule(
  $id: UUID!,
  $status: String,
  $retryCount: Int,
  $lastAttempt: Timestamp,
  $errorMessage: String
) @auth(level: NO_ACCESS, insecureReason: "Admin only - handled by API middleware") {
  contentSchedule_update(
    id: $id,
    data: {
      status: $status,
      retryCount: $retryCount,
      lastAttempt: $lastAttempt,
      errorMessage: $errorMessage,
      updatedAt_expr: "request.time"
    }
  )
}
