name: Smoke Test ‚Äì Incident Feed

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"   # every 6 hours

jobs:
  verify-incident-feed:
    runs-on: ubuntu-latest
    steps:
      - name: Hit /api/incidents
        run: |
          echo "üîç Checking externalized incident feed..."
          FEED_URL="https://audiojones.com/api/incidents"
          TOKEN_QUERY=""
          if [ -n "${{ secrets.INCIDENT_FEED_TOKEN }}" ]; then
            TOKEN_QUERY="?token=${{ secrets.INCIDENT_FEED_TOKEN }}"
          fi
          RESP=$(curl -s -o resp.json -w "%{http_code}" "${FEED_URL}${TOKEN_QUERY}")
          echo "HTTP: $RESP"
          if [ "$RESP" != "200" ]; then
            echo "‚ùå Feed returned $RESP"; cat resp.json; exit 1
          fi
          jq .ok resp.json | grep true >/dev/null || (echo "‚ùå Feed missing ok:true"; exit 1)
          echo "‚úÖ Feed structure ok"
          jq -r '.incidents[0] | {id, title, status, updated_at}' resp.json
          echo "‚úÖ Smoke test complete"
        env:
          INCIDENT_FEED_TOKEN: ${{ secrets.INCIDENT_FEED_TOKEN }}

  verify-public-incident-api:
    runs-on: ubuntu-latest
    steps:
      - name: Hit /api/public/incidents
        run: |
          echo "üîç Checking public incident API..."
          PUBLIC_URL="https://audiojones.com/api/public/incidents"
          RESP=$(curl -s -o public_resp.json -w "%{http_code}" "${PUBLIC_URL}")
          echo "HTTP: $RESP"
          if [ "$RESP" != "200" ]; then
            echo "‚ùå Public API returned $RESP"; cat public_resp.json; exit 1
          fi
          jq .ok public_resp.json | grep true >/dev/null || (echo "‚ùå Public API missing ok:true"; exit 1)
          echo "‚úÖ Public API structure ok"
          
          # Test with query parameters
          FILTERED_RESP=$(curl -s -o filtered_resp.json -w "%{http_code}" "${PUBLIC_URL}?status=open&limit=5")
          echo "Filtered query HTTP: $FILTERED_RESP"
          if [ "$FILTERED_RESP" != "200" ]; then
            echo "‚ùå Filtered query failed"; exit 1
          fi
          echo "‚úÖ Filtered queries working"

  verify-status-page:
    runs-on: ubuntu-latest
    steps:
      - name: Hit /status page
        run: |
          echo "üîç Checking public status page..."
          STATUS_URL="https://audiojones.com/status"
          RESP=$(curl -s -o status.html -w "%{http_code}" "${STATUS_URL}")
          echo "HTTP: $RESP"
          if [ "$RESP" != "200" ]; then
            echo "‚ùå Status page returned $RESP"; exit 1
          fi
          
          # Check for expected content
          grep -q "System Status" status.html || (echo "‚ùå Status page missing title"; exit 1)
          grep -q "Current Status" status.html || (echo "‚ùå Status page missing status widget"; exit 1)
          
          echo "‚úÖ Status page loads with expected content"
          echo "Page size: $(wc -c < status.html) bytes"

  verify-no-admin-leaks:
    runs-on: ubuntu-latest
    steps:
      - name: Check for admin field leaks
        run: |
          echo "üîç Verifying no admin-only fields in public APIs..."
          
          # Check incidents feed
          curl -s "https://audiojones.com/api/incidents" > incidents.json
          
          # Look for admin-only fields that should NOT be present
          ADMIN_FIELDS=("admin_notes" "runbooks" "internal_metadata" "actor" "processing_logs")
          
          for field in "${ADMIN_FIELDS[@]}"; do
            if grep -q "\"$field\"" incidents.json; then
              echo "‚ùå SECURITY ISSUE: Found admin field '$field' in public feed"
              exit 1
            fi
          done
          
          echo "‚úÖ No admin fields leaked in public feed"
          
          # Check public API too
          curl -s "https://audiojones.com/api/public/incidents" > public_incidents.json
          
          for field in "${ADMIN_FIELDS[@]}"; do
            if grep -q "\"$field\"" public_incidents.json; then
              echo "‚ùå SECURITY ISSUE: Found admin field '$field' in public API"
              exit 1
            fi
          done
          
          echo "‚úÖ No admin fields leaked in public API"

  verify-cors-headers:
    runs-on: ubuntu-latest
    steps:
      - name: Check CORS headers
        run: |
          echo "üîç Checking CORS headers on public endpoints..."
          
          # Check original incidents API
          CORS_HEADERS=$(curl -s -I "https://audiojones.com/api/incidents" | grep -i "access-control-allow-origin" || echo "")
          if [ -z "$CORS_HEADERS" ]; then
            echo "‚ùå Missing CORS headers on /api/incidents"
            exit 1
          fi
          echo "‚úÖ CORS headers present on /api/incidents"
          
          # Check public API
          PUBLIC_CORS=$(curl -s -I "https://audiojones.com/api/public/incidents" | grep -i "access-control-allow-origin" || echo "")
          if [ -z "$PUBLIC_CORS" ]; then
            echo "‚ùå Missing CORS headers on /api/public/incidents"
            exit 1
          fi
          echo "‚úÖ CORS headers present on /api/public/incidents"
          
          # Test OPTIONS request
          OPTIONS_RESP=$(curl -s -o /dev/null -w "%{http_code}" -X OPTIONS "https://audiojones.com/api/public/incidents")
          if [ "$OPTIONS_RESP" != "200" ]; then
            echo "‚ùå OPTIONS request failed: $OPTIONS_RESP"
            exit 1
          fi
          echo "‚úÖ OPTIONS preflight requests working"