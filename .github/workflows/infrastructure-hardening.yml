name: Infrastructure Hardening - API Route Testing

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily at 6:00 AM UTC
    - cron: '0 6 * * *'

env:
  PRODUCTION_URL: https://audiojones.com
  ADMIN_API_KEY: ${{ secrets.ADMIN_API_KEY }}

jobs:
  route-testing:
    name: Critical Route Testing
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Test Core Platform Routes
      run: |
        echo "ğŸ§ª Testing critical API routes..."
        
        # Test admin health endpoint
        curl -f -H "admin-key: $ADMIN_API_KEY" \
          "$PRODUCTION_URL/api/admin/health" || exit 1
        echo "âœ… Admin health check passed"
        
        # Test admin stats endpoint  
        curl -f -H "admin-key: $ADMIN_API_KEY" \
          "$PRODUCTION_URL/api/admin/stats" || exit 1
        echo "âœ… Admin stats check passed"
        
        # Test webhook endpoint (HEAD request)
        curl -f -I "$PRODUCTION_URL/api/webhooks/whop" || exit 1
        echo "âœ… Whop webhook endpoint accessible"

    - name: Test Post-MVP Automation Routes
      run: |
        echo "ğŸ¤– Testing automation system routes..."
        
        # Test analytics endpoint
        curl -f -H "admin-key: $ADMIN_API_KEY" \
          "$PRODUCTION_URL/api/admin/analytics/summary" || exit 1
        echo "âœ… Analytics endpoint passed"
        
        # Test maintenance system endpoint
        curl -f -H "admin-key: $ADMIN_API_KEY" \
          "$PRODUCTION_URL/api/system/maintenance" || exit 1
        echo "âœ… Maintenance system passed"
        
        # Test auto-alerts endpoint
        curl -f -H "admin-key: $ADMIN_API_KEY" \
          "$PRODUCTION_URL/api/admin/auto-alerts" || exit 1
        echo "âœ… Auto-alerts system passed"

    - name: Test Client Portal Routes
      run: |
        echo "ğŸ‘¥ Testing client portal routes..."
        
        # Test client billing portal (should require auth, expect 401/403)
        response=$(curl -s -o /dev/null -w "%{http_code}" \
          "$PRODUCTION_URL/api/client/billing/portal")
        if [[ "$response" == "401" || "$response" == "403" ]]; then
          echo "âœ… Client billing portal auth protection working"
        else
          echo "âŒ Client billing portal auth issue (got $response)"
          exit 1
        fi

    - name: Test Infrastructure Hardening Routes
      run: |
        echo "ğŸ”§ Testing infrastructure hardening routes..."
        
        # Test infrastructure status endpoint
        curl -f -H "admin-key: $ADMIN_API_KEY" \
          "$PRODUCTION_URL/api/admin/infrastructure" || exit 1
        echo "âœ… Infrastructure endpoint passed"

    - name: Performance Baseline Testing
      run: |
        echo "âš¡ Running performance baseline tests..."
        
        # Test response time for critical endpoints
        admin_health_time=$(curl -w "%{time_total}" -s -o /dev/null \
          -H "admin-key: $ADMIN_API_KEY" \
          "$PRODUCTION_URL/api/admin/health")
        
        echo "ğŸ“Š Admin health response time: ${admin_health_time}s"
        
        # Fail if response time > 3 seconds
        if (( $(echo "$admin_health_time > 3.0" | bc -l) )); then
          echo "âŒ Response time too slow: ${admin_health_time}s"
          exit 1
        fi
        
        echo "âœ… Performance baseline passed"

    - name: Generate Test Report
      if: always()
      run: |
        echo "ğŸ“‹ Infrastructure Route Testing Report"
        echo "======================================"
        echo "Timestamp: $(date -u)"
        echo "Production URL: $PRODUCTION_URL"
        echo "Test Result: ${{ job.status }}"
        echo ""
        echo "Tested Routes:"
        echo "- âœ… /api/admin/health"
        echo "- âœ… /api/admin/stats" 
        echo "- âœ… /api/webhooks/whop"
        echo "- âœ… /api/admin/analytics/summary"
        echo "- âœ… /api/system/maintenance"
        echo "- âœ… /api/admin/auto-alerts"
        echo "- âœ… /api/client/billing/portal"
        echo "- âœ… /api/admin/infrastructure"
        echo ""
        echo "Performance: Response times under 3s threshold"
        echo "Security: Authentication protection verified"

    - name: Notify on Failure
      if: failure()
      run: |
        echo "ğŸš¨ CRITICAL: Infrastructure route testing failed!"
        echo "This indicates potential production issues that need immediate attention."
        echo "Check the logs above for specific failing endpoints."
        exit 1

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: route-testing
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Run Security Audit
      run: |
        echo "ğŸ”’ Running security audit..."
        npm audit --audit-level high
        echo "âœ… Security audit completed"

    - name: Test Authentication Endpoints
      run: |
        echo "ğŸ›¡ï¸ Testing authentication security..."
        
        # Test admin routes without API key (should fail)
        response=$(curl -s -o /dev/null -w "%{http_code}" \
          "$PRODUCTION_URL/api/admin/stats")
        if [[ "$response" == "401" || "$response" == "403" ]]; then
          echo "âœ… Admin routes properly protected"
        else
          echo "âŒ Admin route security issue (got $response)"
          exit 1
        fi
        
        # Test with invalid API key (should fail)
        response=$(curl -s -o /dev/null -w "%{http_code}" \
          -H "admin-key: invalid-key-test" \
          "$PRODUCTION_URL/api/admin/stats")
        if [[ "$response" == "401" || "$response" == "403" ]]; then
          echo "âœ… Invalid API key properly rejected"
        else
          echo "âŒ Invalid API key security issue (got $response)"
          exit 1
        fi

  deployment-verification:
    name: Deployment Verification
    runs-on: ubuntu-latest
    needs: [route-testing, security-scan]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Verify Production Deployment
      run: |
        echo "ğŸš€ Verifying production deployment..."
        
        # Wait for deployment to complete
        sleep 60
        
        # Verify all new automation systems are deployed
        endpoints=(
          "/api/admin/analytics/summary"
          "/api/system/maintenance" 
          "/api/admin/auto-alerts"
          "/api/admin/infrastructure"
        )
        
        for endpoint in "${endpoints[@]}"; do
          response=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "admin-key: $ADMIN_API_KEY" \
            "$PRODUCTION_URL$endpoint")
          if [[ "$response" == "200" ]]; then
            echo "âœ… $endpoint deployed successfully"
          else
            echo "âŒ $endpoint deployment issue (got $response)"
            exit 1
          fi
        done
        
        echo "ğŸ‰ All post-MVP automation systems successfully deployed!"